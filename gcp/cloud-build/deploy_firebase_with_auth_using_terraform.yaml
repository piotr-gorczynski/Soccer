substitutions:
  _ENVIRONMENT: 'dev'
  _FOLDER_NAME: 'soccer'

steps:
  # Step 1: Get Firebase Project ID
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'get-project-id'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        echo "üîç Looking for project starting with ${_FOLDER_NAME}-${_ENVIRONMENT}..."
        gcloud projects list \
          --filter="name~^${_FOLDER_NAME}-${_ENVIRONMENT}" \
          --format="value(projectId)" | head -n 1 > /workspace/project_id.txt

        if [ ! -s /workspace/project_id.txt ]; then
          echo "‚ùå Firebase project not found."
          exit 1
        fi

        echo "‚úÖ Found project ID: $(cat /workspace/project_id.txt)"

  # Step 2: Enable Identity Platform API (with debug and retries)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'enable-identityplatform-api'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        set -x

        firebase_project_id=$(cat /workspace/project_id.txt)
        echo "üîì Enabling Identity Platform API for project: $firebase_project_id..."

        for i in {1..5}; do
          if gcloud services enable identityplatform.googleapis.com --project="$firebase_project_id"; then
            echo "‚úÖ identityplatform.googleapis.com enabled."
            break
          fi

          echo "‚ö†Ô∏è Attempt $i failed. Waiting for IAM permissions to propagate..."
          sleep 20
        done

        # Final check to confirm API is enabled
        if ! gcloud services list --enabled --project="$firebase_project_id" \
             --filter="config.name:identityplatform.googleapis.com" \
             --format="value(config.name)" | grep -q identityplatform.googleapis.com; then
          echo "‚ùå identityplatform.googleapis.com still not enabled. Failing pipeline."
          exit 1
        fi

        echo "‚úÖ API confirmed enabled after retry."


  # Step 3: Write Terraform config using google-beta provider
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'write-tf-config'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        mkdir -p /workspace/tf-auth
        cat <<EOF > /workspace/tf-auth/main.tf
        terraform {
          required_providers {
            google-beta = {
              source  = "hashicorp/google-beta"
              version = ">= 4.80.0"
            }
          }
        }

        provider "google-beta" {
          project = "$(cat /workspace/project_id.txt)"
        }

        resource "google_identity_platform_project_default_config" "default" {
          provider = google-beta
          project  = "$(cat /workspace/project_id.txt)"
          sign_in {
            email {
              enabled = true
            }
            anonymous {
              enabled = false
            }
            phone_number {
              enabled = false
            }
          }
        }
        EOF

  # Step 4: Terraform Init
  - name: 'hashicorp/terraform:light'
    id: 'terraform-init'
    dir: '/workspace/tf-auth'
    entrypoint: 'sh'
    args: ['-c', 'terraform init']

  # Step 5: Terraform Apply
  - name: 'hashicorp/terraform:light'
    id: 'terraform-apply'
    dir: '/workspace/tf-auth'
    entrypoint: 'sh'
    args: ['-c', 'terraform apply -auto-approve']

options:
  logging: CLOUD_LOGGING_ONLY
