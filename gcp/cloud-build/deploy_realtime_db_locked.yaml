# deploy_realtime_db_locked.yaml
substitutions:
  _ENVIRONMENT: 'dev'
  _FOLDER_NAME: 'soccer'

steps:
# 0. Resolve Firebase project ID
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
  id: 'get-project-id'
  entrypoint: bash
  args:
    - '-c'
    - |
      set -ex
      gcloud projects list \
        --filter="name~^${_FOLDER_NAME}-${_ENVIRONMENT}" \
        --format="value(projectId)" \
      | head -n1 > /workspace/FIREBASE_PROJECT_ID.txt
      test -s /workspace/FIREBASE_PROJECT_ID.txt

# 1. Clone your source (to pull in firebase.json & database.rules.json)
- name: 'gcr.io/cloud-builders/git'
  id: 'pull-source'
  entrypoint: bash
  args:
    - '-c'
    - |
      set -ex
      git clone -b development --single-branch \
        https://github.com/piotr-gorczynski/Soccer.git /workspace/soccer
      cp /workspace/soccer/gcp/cloud-build/firebase.json  /workspace/firebase.json
      cp /workspace/soccer/gcp/cloud-build/database.rules.json /workspace/database.rules.json

# 2. Install Firebase CLI
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
  id: 'install-firebase-cli'
  entrypoint: bash
  args:
    - '-c'
    - |
      set -ex
      echo "⬇️ Installing Firebase CLI..."
      curl -sL https://firebase.tools | bash
      mkdir -p /workspace/firebase
      cp /usr/local/bin/firebase /workspace/firebase/
      chmod +x /workspace/firebase/firebase
      echo "✅ Firebase CLI installed."

# 3. Call the Firebase Management API to create the DEFAULT RTDB
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
  id: 'create-default-rtdb-via-api'
  entrypoint: bash
  args:
    - '-c'
    - |
      set -ex
      PROJECT=$(cat /workspace/FIREBASE_PROJECT_ID.txt)
      INSTANCE_ID="${PROJECT}-default-rtdb"
      LOCATION="us-central1"
      echo "🚀 Creating default RTDB $INSTANCE_ID in $LOCATION via REST API…"
      TOKEN="$(gcloud auth print-access-token)"
      HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
        -X POST \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"instanceId\":\"$INSTANCE_ID\",\"locationId\":\"$LOCATION\",\"type\":\"DEFAULT_DATABASE\"}" \
        "https://firebase.googleapis.com/v1beta1/projects/$PROJECT/locations/$LOCATION/instances")
      if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 409 ]; then
        echo "✅ RTDB default instance created (or already exists)."
      else
        echo "❌ Failed to create default RTDB (HTTP $HTTP_CODE)." >&2
        exit 1
      fi

# 4. Deploy locked-mode rules via firebase.json
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
  id: 'deploy-locked-rules'
  entrypoint: bash
  args:
    - '-c'
    - |
      set -ex
      PROJECT=$(cat /workspace/FIREBASE_PROJECT_ID.txt)
      cd /workspace
      echo "🔒 Deploying locked-mode rules…"
      /workspace/firebase/firebase deploy \
        --only database \
        --project "$PROJECT" \
        --force

options:
  logging: CLOUD_LOGGING_ONLY
